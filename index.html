<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•…äº‹è®°å½•</title>
    <!-- æ·»åŠ JSZipåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Comic Sans MS', 'Arial Rounded MT Bold', Arial, sans-serif;
        }
        
        body {
            background-color: #f0f9ff;
            color: #333;
            padding: 20px;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .container {
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 30px;
        }
        
        h1 {
            color: #4a6fa5;
            text-align: center;
            margin-bottom: 20px;
            font-size: 2.5rem;
        }
        
        h2 {
            color: #6b9ac4;
            margin-bottom: 15px;
            border-bottom: 2px dashed #cae1f1;
            padding-bottom: 8px;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* åˆå§‹ä¿¡æ¯è¾“å…¥æ ·å¼ */
        .info-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #5a7ca8;
            font-weight: bold;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #cae1f1;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #6b9ac4;
        }
        
        /* æŒ‡å¯¼è¯­æ ·å¼ */
        .instructions {
            background-color: #e8f4fc;
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            border-left: 6px solid #4a6fa5;
        }
        
        /* æ•…äº‹æµè§ˆæ ·å¼ */
        .story-container {
            text-align: center;
            margin: 25px 0;
        }
        
        .story-image {
            max-width: 100%;
            max-height: 500px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: 5px solid white;
        }
        
        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        
        .btn {
            background-color: #6b9ac4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        .btn:hover {
            background-color: #4a6fa5;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-primary {
            background-color: #ff9a8b;
            background-image: linear-gradient(90deg, #ff9a8b 0%, #ff6a88 55%, #ff99ac 100%);
        }
        
        .btn-primary:hover {
            background-color: #ff7a6b;
        }
        
        .btn-success {
            background-color: #5cdb95;
        }
        
        .btn-success:hover {
            background-color: #38b87c;
        }
        
        .page-indicator {
            font-size: 18px;
            color: #5a7ca8;
            font-weight: bold;
        }
        
        /* å½•éŸ³ç•Œé¢æ ·å¼ */
        .recording-status {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            border-radius: 15px;
            background-color: #fff5f5;
            border: 2px solid #ffcccc;
        }
        
        .recording {
            background-color: #f0fff0;
            border: 2px solid #a3e4a3;
        }
        
        .pulse {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ff3333;
            margin-right: 10px;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(0.9); opacity: 0.7; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(0.9); opacity: 0.7; }
        }
        
        .audio-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 25px 0;
        }
        
        .all-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin: 25px 0;
        }
        
        .story-thumbnail {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 10px;
            border: 3px solid white;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .story-thumbnail:hover {
            transform: scale(1.05);
        }
        
        /* æ•°æ®æ‘˜è¦æ ·å¼ */
        .summary {
            background-color: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-top: 25px;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .summary-item:last-child {
            border-bottom: none;
        }
        
        .summary-label {
            font-weight: bold;
            color: #5a7ca8;
        }
        
        .summary-value {
            color: #333;
        }
        
        .timer {
            font-size: 18px;
            font-weight: bold;
            color: #4a6fa5;
            background-color: #e8f4fc;
            padding: 10px 15px;
            border-radius: 10px;
            display: inline-block;
            margin: 10px 0;
        }
        
        /* è¿›åº¦æŒ‡ç¤ºå™¨ */
        .progress-container {
            margin: 30px 0;
        }
        
        .progress-bar {
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(90deg, #6b9ac4, #4a6fa5);
            width: 0%;
            transition: width 0.5s;
        }
        
        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        
        .step {
            text-align: center;
            font-size: 14px;
            color: #888;
        }
        
        .step.active {
            color: #4a6fa5;
            font-weight: bold;
        }
        
        /* é”™è¯¯æç¤ºæ ·å¼ */
        .error-message {
            background-color: #ffe6e6;
            color: #cc0000;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            border: 1px solid #ffcccc;
        }
        
        .success-message {
            background-color: #e8f5e8;
            color: #2d572d;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            border: 1px solid #a3e4a3;
        }
        
        /* éŸ³é¢‘é¢„è§ˆæ ·å¼ */
        .audio-preview {
            margin: 20px 0;
            text-align: center;
        }
        
        .audio-preview audio {
            width: 100%;
            max-width: 500px;
            margin-top: 10px;
        }
        
        /* ä¸‹è½½æŒ‰é’®ç»„æ ·å¼ */
        .download-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .info-form {
                grid-template-columns: 1fr;
            }
            
            .all-images {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .navigation {
                flex-direction: column;
                gap: 15px;
            }
            
            .btn {
                width: 100%;
            }
            
            .download-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <h1>ğŸ“š æ•…äº‹è®°å½•</h1>
    
    <div class="progress-container">
        <div class="progress-bar">
            <div class="progress" id="progress"></div>
        </div>
        <div class="progress-steps">
            <div class="step active" id="step1">1. åŸºæœ¬ä¿¡æ¯</div>
            <div class="step" id="step2">2. æŒ‡å¯¼è¯­</div>
            <div class="step" id="step3">3. æµè§ˆæ•…äº‹</div>
            <div class="step" id="step4">4. å½•éŸ³</div>
            <div class="step" id="step5">5. å®Œæˆ</div>
        </div>
    </div>
    
    <!-- ç¬¬1æ­¥ï¼šåŸºæœ¬ä¿¡æ¯è¾“å…¥ -->
    <div class="container" id="info-section">
        <h2>åŸºæœ¬ä¿¡æ¯</h2>
        <p>è¯·å¡«å†™ä»¥ä¸‹ä¿¡æ¯å¼€å§‹è®²æ•…äº‹å®éªŒ</p>
        
        <form id="child-info-form">
            <div class="info-form">
                <div class="form-group">
                    <label for="child-name">å§“åï¼š</label>
                    <input type="text" id="child-name" required placeholder="è¯·è¾“å…¥å§“å">
                </div>
                
                <div class="form-group">
                    <label for="child-age">å¹´é¾„ï¼š</label>
                    <input type="number" id="child-age" min="3" max="80" required placeholder="3-80å²">
                </div>
                
                <div class="form-group">
                    <label for="child-gender">æ€§åˆ«ï¼š</label>
                    <select id="child-gender" required>
                        <option value="">è¯·é€‰æ‹©</option>
                        <option value="ç”·">ç”·</option>
                        <option value="å¥³">å¥³</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="experiment-date">å®éªŒæ—¥æœŸï¼š</label>
                    <input type="datetime-local" id="experiment-date" required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="image-count">æ•…äº‹å›¾ç‰‡æ•°é‡ï¼š</label>
                <input type="number" id="image-count" min="1" max="50" value="5" placeholder="é»˜è®¤ä¸º5">
                <small>å¦‚æœè‡ªåŠ¨æ£€æµ‹å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è®¾ç½®</small>
            </div>
            
            <div id="image-check-result"></div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button type="button" class="btn" id="test-images" style="background-color: #6c757d; margin-right: 10px;">
                    æµ‹è¯•å›¾ç‰‡åŠ è½½
                </button>
                <button type="submit" class="btn btn-primary">å¼€å§‹å®éªŒ</button>
            </div>
        </form>
    </div>
    
    <!-- ç¬¬2æ­¥ï¼šæŒ‡å¯¼è¯­ -->
    <div class="container hidden" id="instructions-section">
        <h2>å®éªŒæŒ‡å¯¼è¯­</h2>
        
        <div class="instructions">
            <p>äº²çˆ±çš„æœ‹å‹ï¼Œä½ å¥½ï¼</p>
            <p>æ¬¢è¿å‚åŠ æˆ‘ä»¬çš„è®²æ•…äº‹å®éªŒã€‚</p>
            <p>æ¥ä¸‹æ¥ä½ ä¼šçœ‹åˆ°ä¸€ç»„å›¾ç‰‡ï¼Œå®ƒä»¬è®²è¿°äº†ä¸€ä¸ªå®Œæ•´çš„æ•…äº‹ã€‚</p>
            <p>é¦–å…ˆï¼Œè¯·ä½ ä»”ç»†æµè§ˆæ¯ä¸€å¼ å›¾ç‰‡ï¼Œäº†è§£æ•´ä¸ªæ•…äº‹çš„å†…å®¹ã€‚</p>
            <p>æµè§ˆå®Œæ‰€æœ‰å›¾ç‰‡åï¼Œæ‰€æœ‰å›¾ç‰‡ä¼šåŒæ—¶æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚</p>
            <p>è¿™æ—¶è¯·æ ¹æ®å›¾ç‰‡å†…å®¹ï¼Œç”¨è‡ªå·±çš„è¯æŠŠæ•…äº‹è®²å‡ºæ¥ã€‚</p>
            <p>å½“ä½ å¼€å§‹è®²æ•…äº‹æ—¶ï¼Œå½•éŸ³ä¼šè‡ªåŠ¨å¼€å§‹ã€‚</p>
            <p>è®²å®Œæ•…äº‹åï¼Œè¯·æŒ‰ä¸‹é”®ç›˜ä¸Šçš„<strong>ç©ºæ ¼é”®</strong>ç»“æŸå½•éŸ³ã€‚</p>
            <p>å‡†å¤‡å¥½äº†å—ï¼Ÿè®©æˆ‘ä»¬å¼€å§‹å§ï¼</p>
        </div>
        
        <div style="text-align: center; margin-top: 30px;">
            <button class="btn" id="back-to-info">è¿”å›</button>
            <button class="btn btn-primary" id="start-story">å¼€å§‹æµè§ˆæ•…äº‹</button>
        </div>
    </div>
    
    <!-- ç¬¬3æ­¥ï¼šæ•…äº‹æµè§ˆ -->
    <div class="container hidden" id="story-section">
        <h2>æµè§ˆæ•…äº‹</h2>
        <p>è¯·ä»”ç»†è§‚çœ‹æ¯ä¸€å¼ å›¾ç‰‡ï¼Œäº†è§£æ•´ä¸ªæ•…äº‹å†…å®¹ã€‚</p>
        
        <div class="story-container">
            <img id="current-image" class="story-image" src="" alt="æ•…äº‹å›¾ç‰‡">
            <div class="page-indicator">
                <span id="current-page">1</span> / <span id="total-pages">0</span>
            </div>
        </div>
        
        <div class="navigation">
            <button class="btn" id="prev-btn">ä¸Šä¸€å¼ </button>
            <button class="btn btn-primary" id="next-btn">ä¸‹ä¸€å¼ </button>
        </div>
        
        <div style="text-align: center; margin-top: 30px;">
            <button class="btn" id="back-to-instructions">è¿”å›æŒ‡å¯¼è¯­</button>
            <button class="btn btn-success" id="start-recording">æµè§ˆå®Œæˆï¼Œå¼€å§‹å½•éŸ³</button>
        </div>
    </div>
    
    <!-- ç¬¬4æ­¥ï¼šå½•éŸ³ç•Œé¢ -->
    <div class="container hidden" id="recording-section">
        <h2>è®²æ•…äº‹æ—¶é—´</h2>
        <p>è¯·æ ¹æ®æ‰€æœ‰å›¾ç‰‡è®²è¿°ä¸€ä¸ªå®Œæ•´çš„æ•…äº‹ã€‚å½“ä½ å¼€å§‹è¯´è¯æ—¶ï¼Œå½•éŸ³ä¼šè‡ªåŠ¨å¼€å§‹ã€‚</p>
        
        <div class="recording-status" id="recording-status">
            <div class="timer">å‡†å¤‡å½•éŸ³...</div>
            <p id="recording-message">è¯·å¼€å§‹è®²è¿°ä½ çš„æ•…äº‹</p>
        </div>
        
        <div class="all-images" id="all-images-container">
            <!-- æ‰€æœ‰æ•…äº‹å›¾ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
        </div>
        
        <div style="text-align: center; margin-top: 30px;">
            <p><strong>æç¤ºï¼š</strong>è®²å®Œæ•…äº‹åï¼Œè¯·æŒ‰é”®ç›˜ä¸Šçš„<strong>ç©ºæ ¼é”®</strong>ç»“æŸå½•éŸ³</p>
            <div class="audio-controls">
                <button class="btn" id="back-to-story">è¿”å›æµè§ˆ</button>
                <button class="btn btn-success" id="finish-recording">å®Œæˆå½•éŸ³</button>
            </div>
        </div>
    </div>
    
    <!-- ç¬¬5æ­¥ï¼šå®Œæˆç•Œé¢ -->
    <div class="container hidden" id="completion-section">
        <h2>å®éªŒå®Œæˆ</h2>
        <p>æ­å–œä½ å®Œæˆäº†è®²æ•…äº‹å®éªŒï¼</p>
        
        <div class="audio-preview" id="audio-preview">
            <h3>å½•éŸ³é¢„è§ˆ</h3>
            <audio id="audio-player" controls></audio>
        </div>
        
        <div class="summary">
            <h3>å®éªŒæ•°æ®æ‘˜è¦</h3>
            <div class="summary-item">
                <span class="summary-label">å§“åï¼š</span>
                <span class="summary-value" id="summary-name">-</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">å¹´é¾„ï¼š</span>
                <span class="summary-value" id="summary-age">-</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">æ€§åˆ«ï¼š</span>
                <span class="summary-value" id="summary-gender">-</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">å®éªŒæ—¶é—´ï¼š</span>
                <span class="summary-value" id="summary-date">-</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">æ•…äº‹æµè§ˆç”¨æ—¶ï¼š</span>
                <span class="summary-value" id="summary-browsing-time">-</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">å½•éŸ³ç”¨æ—¶ï¼š</span>
                <span class="summary-value" id="summary-recording-time">-</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">æ€»ç”¨æ—¶ï¼š</span>
                <span class="summary-value" id="summary-total-time">-</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">éŸ³é¢‘æ–‡ä»¶ï¼š</span>
                <span class="summary-value" id="summary-audio-file">-</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">æ•°æ®æ–‡ä»¶ï¼š</span>
                <span class="summary-value" id="summary-data-file">-</span>
            </div>
        </div>
        
        <div class="download-buttons">
            <button class="btn btn-primary" id="download-all">ä¸‹è½½å®éªŒæ•°æ®åŒ…(ZIP)</button>
            <button class="btn" id="restart-experiment">é‡æ–°å¼€å§‹å®éªŒ</button>
        </div>
    </div>

    <script>
        // WAVéŸ³é¢‘ç¼–ç å™¨
        class WavAudioEncoder {
            constructor(sampleRate = 44100, numChannels = 1, bitsPerSample = 16) {
                this.sampleRate = sampleRate;
                this.numChannels = numChannels;
                this.bitsPerSample = bitsPerSample;
                this.bytesPerSample = bitsPerSample / 8;
                this.audioData = [];
            }
            
            // æ·»åŠ éŸ³é¢‘æ•°æ®
            addAudioData(float32Array) {
                // å°†æµ®ç‚¹éŸ³é¢‘æ•°æ®è½¬æ¢ä¸º16ä½æ•´æ•°
                const int16Array = this.floatTo16BitPCM(float32Array);
                this.audioData.push(int16Array);
            }
            
            // æµ®ç‚¹æ•°è½¬16ä½PCM
            floatTo16BitPCM(float32Array) {
                const length = float32Array.length;
                const int16Array = new Int16Array(length);
                
                for (let i = 0; i < length; i++) {
                    // å°†-1åˆ°1çš„æµ®ç‚¹æ•°è½¬æ¢ä¸º-32768åˆ°32767çš„æ•´æ•°
                    const s = Math.max(-1, Math.min(1, float32Array[i]));
                    int16Array[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                }
                
                return int16Array;
            }
            
            // è·å–WAVæ–‡ä»¶Blob
            getWavBlob() {
                // åˆå¹¶æ‰€æœ‰éŸ³é¢‘æ•°æ®
                const totalLength = this.audioData.reduce((sum, arr) => sum + arr.length, 0);
                const mergedData = new Int16Array(totalLength);
                
                let offset = 0;
                for (const chunk of this.audioData) {
                    mergedData.set(chunk, offset);
                    offset += chunk.length;
                }
                
                // è®¡ç®—æ•°æ®å¤§å°
                const dataSize = mergedData.length * this.bytesPerSample;
                const fileSize = 36 + dataSize; // å¤´éƒ¨36å­—èŠ‚ + æ•°æ®å¤§å°
                
                // åˆ›å»ºArrayBuffer
                const buffer = new ArrayBuffer(44 + dataSize);
                const view = new DataView(buffer);
                
                // å†™å…¥WAVæ–‡ä»¶å¤´
                // RIFFæ ‡è¯†ç¬¦
                this.writeString(view, 0, 'RIFF');
                // æ–‡ä»¶å¤§å°
                view.setUint32(4, 36 + dataSize, true);
                // WAVEæ ‡è¯†ç¬¦
                this.writeString(view, 8, 'WAVE');
                // fmtå­å—
                this.writeString(view, 12, 'fmt ');
                // fmtå—å¤§å°
                view.setUint32(16, 16, true);
                // éŸ³é¢‘æ ¼å¼ï¼ˆ1è¡¨ç¤ºPCMï¼‰
                view.setUint16(20, 1, true);
                // å£°é“æ•°
                view.setUint16(22, this.numChannels, true);
                // é‡‡æ ·ç‡
                view.setUint32(24, this.sampleRate, true);
                // å­—èŠ‚ç‡
                view.setUint32(28, this.sampleRate * this.numChannels * this.bytesPerSample, true);
                // å—å¯¹é½
                view.setUint16(32, this.numChannels * this.bytesPerSample, true);
                // ä½æ·±åº¦
                view.setUint16(34, this.bitsPerSample, true);
                // dataå­å—
                this.writeString(view, 36, 'data');
                // dataå—å¤§å°
                view.setUint32(40, dataSize, true);
                
                // å†™å…¥éŸ³é¢‘æ•°æ®
                const offsetBytes = 44;
                for (let i = 0; i < mergedData.length; i++) {
                    view.setInt16(offsetBytes + i * 2, mergedData[i], true);
                }
                
                return new Blob([buffer], { type: 'audio/wav' });
            }
            
            // å†™å…¥å­—ç¬¦ä¸²åˆ°DataView
            writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }
            
            // é‡ç½®ç¼–ç å™¨
            reset() {
                this.audioData = [];
            }
        }

        // åº”ç”¨çŠ¶æ€ç®¡ç†
        const AppState = {
            currentStep: 1,
            childInfo: {
                name: '',
                age: '',
                gender: '',
                experimentDate: ''
            },
            timers: {
                browsingStart: null,
                browsingTime: 0,
                recordingStart: null,
                recordingTime: 0,
                totalStart: null,
                totalTime: 0
            },
            currentImageIndex: 0,
            totalImages: 6, // é»˜è®¤å€¼
            audioContext: null,
            mediaStream: null,
            processor: null,
            wavEncoder: null,
            isRecording: false,
            wavBlob: null,
            imageViewTimes: [],
            currentImageViewStart: null,
            pageNavigationLog: [],
            recordingStartTimestamp: null,
            experimentEndTimestamp: null,
            isGeneratingZip: false
        };

        // åº”ç”¨é…ç½® - å…³é”®ä¿®æ”¹ï¼šé€‚åº”GitHub Pagesè·¯å¾„
        const AppConfig = {
            imageFolder: '/-/picture', // GitHub Pagesè·¯å¾„
            imageFormat: 'jpg',
            startIndex: 1,
            maxImages: 50,
            audioSampleRate: 44100,
            imageFormats: ['jpg', 'jpeg', 'png', 'gif', 'webp']
        };

        // DOMå…ƒç´ 
        const sections = {
            info: document.getElementById('info-section'),
            instructions: document.getElementById('instructions-section'),
            story: document.getElementById('story-section'),
            recording: document.getElementById('recording-section'),
            completion: document.getElementById('completion-section')
        };

        const progressBar = document.getElementById('progress');
        const steps = document.querySelectorAll('.step');

        // åˆå§‹åŒ–å‡½æ•°
        async function initApp() {
            console.log('åˆå§‹åŒ–åº”ç”¨...');
            console.log('å½“å‰é¡µé¢URL:', window.location.href);
            console.log('å›¾ç‰‡è·¯å¾„é…ç½®:', AppConfig.imageFolder);
            
            // è®¾ç½®å½“å‰æ—¥æœŸæ—¶é—´ä¸ºé»˜è®¤å€¼
            const now = new Date();
            const localDateTime = now.toISOString().slice(0, 16);
            document.getElementById('experiment-date').value = localDateTime;
            
            // è®¾ç½®é»˜è®¤å›¾ç‰‡æ•°é‡
            const imageCountInput = document.getElementById('image-count');
            if (imageCountInput) {
                imageCountInput.value = AppState.totalImages;
            }
            
            // åˆå§‹åŒ–è¿›åº¦æ¡
            updateProgress();
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners();
            
            // æ˜¾ç¤ºå½“å‰é…ç½®
            document.getElementById('image-check-result').innerHTML = `
                <div class="success-message">
                    å½“å‰å›¾ç‰‡è·¯å¾„: ${AppConfig.imageFolder}/1.jpg
                </div>
            `;
        }

        // æ£€æŸ¥å›¾ç‰‡æ˜¯å¦å­˜åœ¨
        function checkImageExists(url) {
            return new Promise((resolve) => {
                const img = new Image();
                let timedOut = false;
                
                const timer = setTimeout(() => {
                    timedOut = true;
                    img.src = ''; // åœæ­¢åŠ è½½
                    resolve(false);
                }, 2000); // 2ç§’è¶…æ—¶
                
                img.onload = function() {
                    if (!timedOut) {
                        clearTimeout(timer);
                        resolve(true);
                    }
                };
                
                img.onerror = function() {
                    if (!timedOut) {
                        clearTimeout(timer);
                        resolve(false);
                    }
                };
                
                // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
                const cacheBuster = `?t=${Date.now()}`;
                img.src = url + cacheBuster;
            });
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // åŸºæœ¬ä¿¡æ¯è¡¨å•æäº¤
            document.getElementById('child-info-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveChildInfo();
                goToStep(2);
            });

            // æµ‹è¯•å›¾ç‰‡åŠ è½½æŒ‰é’®
            document.getElementById('test-images').addEventListener('click', testImageLoading);

            // è¿”å›æŒ‰é’®
            document.getElementById('back-to-info').addEventListener('click', () => goToStep(1));
            document.getElementById('back-to-instructions').addEventListener('click', () => goToStep(2));
            document.getElementById('back-to-story').addEventListener('click', () => goToStep(3));

            // å¼€å§‹æ•…äº‹æµè§ˆ
            document.getElementById('start-story').addEventListener('click', () => {
                AppState.timers.browsingStart = Date.now();
                AppState.timers.totalStart = Date.now();
                loadStoryImages();
                goToStep(3);
            });

            // æ•…äº‹å¯¼èˆª
            document.getElementById('prev-btn').addEventListener('click', showPrevImage);
            document.getElementById('next-btn').addEventListener('click', showNextImage);

            // å¼€å§‹å½•éŸ³
            document.getElementById('start-recording').addEventListener('click', () => {
                // è®°å½•æµè§ˆç»“æŸæ—¶é—´
                AppState.timers.browsingTime = Date.now() - AppState.timers.browsingStart;
                // è®°å½•æœ€åä¸€å¼ å›¾ç‰‡çš„æµè§ˆç»“æŸæ—¶é—´
                if (AppState.currentImageViewStart) {
                    const viewTime = Date.now() - AppState.currentImageViewStart;
                    AppState.imageViewTimes[AppState.currentImageIndex] += viewTime;
                    AppState.currentImageViewStart = null;
                }
                goToStep(4);
                setTimeout(initRecording, 500);
            });

            // å®Œæˆå½•éŸ³æŒ‰é’®
            document.getElementById('finish-recording').addEventListener('click', stopRecording);

            // ç©ºæ ¼é”®ç»“æŸå½•éŸ³
            document.addEventListener('keydown', function(e) {
                if (e.code === 'Space' && AppState.isRecording && AppState.currentStep === 4) {
                    e.preventDefault();
                    stopRecording();
                }
            });

            // ä¸‹è½½æ‰€æœ‰æ–‡ä»¶ï¼ˆZIPåŒ…ï¼‰
            document.getElementById('download-all').addEventListener('click', downloadAllFiles);

            // é‡æ–°å¼€å§‹å®éªŒ
            document.getElementById('restart-experiment').addEventListener('click', restartExperiment);
        }

        // æµ‹è¯•å›¾ç‰‡åŠ è½½
        async function testImageLoading() {
            const testBtn = document.getElementById('test-images');
            const originalText = testBtn.textContent;
            testBtn.textContent = 'æµ‹è¯•ä¸­...';
            testBtn.disabled = true;
            
            const resultDiv = document.getElementById('image-check-result');
            resultDiv.innerHTML = '<div>æ­£åœ¨æµ‹è¯•å›¾ç‰‡åŠ è½½...</div>';
            
            // è·å–æ‰‹åŠ¨è®¾ç½®çš„å›¾ç‰‡æ•°é‡
            const manualCount = parseInt(document.getElementById('image-count').value) || 5;
            AppState.totalImages = manualCount;
            
            // æµ‹è¯•å‰3å¼ å›¾ç‰‡
            let successCount = 0;
            const testResults = [];
            
            for (let i = 1; i <= Math.min(3, AppState.totalImages); i++) {
                const testUrl = `${AppConfig.imageFolder}/${i}.${AppConfig.imageFormat}`;
                
                try {
                    const exists = await checkImageExists(testUrl);
                    if (exists) {
                        successCount++;
                        testResults.push(`âœ… å›¾ç‰‡ ${i}: å¯åŠ è½½`);
                    } else {
                        testResults.push(`âŒ å›¾ç‰‡ ${i}: ä¸å¯åŠ è½½`);
                    }
                } catch (error) {
                    testResults.push(`âŒ å›¾ç‰‡ ${i}: æ£€æµ‹å¤±è´¥`);
                }
                
                // å»¶è¿Ÿä¸€ä¸‹ï¼Œé¿å…è¯·æ±‚è¿‡å¿«
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            if (successCount > 0) {
                resultDiv.innerHTML = `
                    <div class="success-message">
                        <strong>âœ… å›¾ç‰‡åŠ è½½æµ‹è¯•æˆåŠŸï¼</strong><br>
                        ${testResults.join('<br>')}<br><br>
                        å·²æ£€æµ‹åˆ° ${successCount} å¼ å›¾ç‰‡å¯æ­£å¸¸åŠ è½½<br>
                        ä½¿ç”¨å›¾ç‰‡æ•°é‡: ${AppState.totalImages}
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="error-message">
                        <strong>âŒ å›¾ç‰‡åŠ è½½æµ‹è¯•å¤±è´¥</strong><br>
                        ${testResults.join('<br>')}<br><br>
                        è¯·æ£€æŸ¥ï¼š<br>
                        1. å›¾ç‰‡æ–‡ä»¶å¤¹è·¯å¾„æ˜¯å¦æ­£ç¡®<br>
                        2. å›¾ç‰‡æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼ˆå½“å‰: ${AppConfig.imageFormat})<br>
                        3. å›¾ç‰‡æ–‡ä»¶åæ˜¯å¦ä¸º 1.jpg, 2.jpg æ ¼å¼<br>
                        4. GitHub Pages æ˜¯å¦å·²æ­£ç¡®éƒ¨ç½²
                    </div>
                `;
            }
            
            testBtn.textContent = originalText;
            testBtn.disabled = false;
        }

        // ä¿å­˜ä¿¡æ¯
        function saveChildInfo() {
            AppState.childInfo = {
                name: document.getElementById('child-name').value,
                age: document.getElementById('child-age').value,
                gender: document.getElementById('child-gender').value,
                experimentDate: document.getElementById('experiment-date').value
            };
            
            // è·å–æ‰‹åŠ¨è®¾ç½®çš„å›¾ç‰‡æ•°é‡
            const imageCountInput = document.getElementById('image-count');
            if (imageCountInput) {
                const manualCount = parseInt(imageCountInput.value) || 5;
                AppState.totalImages = manualCount;
            }
        }

        // å¯¼èˆªåˆ°æŒ‡å®šæ­¥éª¤
        function goToStep(step) {
            // è®°å½•é¡µé¢åˆ‡æ¢
            const timestamp = Date.now();
            AppState.pageNavigationLog.push({
                fromStep: AppState.currentStep,
                toStep: step,
                timestamp: timestamp,
                timeFromStart: timestamp - (AppState.timers.totalStart || timestamp)
            });
            
            // éšè—æ‰€æœ‰éƒ¨åˆ†
            Object.values(sections).forEach(section => {
                section.classList.add('hidden');
            });

            // æ˜¾ç¤ºç›®æ ‡éƒ¨åˆ†
            switch(step) {
                case 1:
                    sections.info.classList.remove('hidden');
                    break;
                case 2:
                    sections.instructions.classList.remove('hidden');
                    break;
                case 3:
                    sections.story.classList.remove('hidden');
                    break;
                case 4:
                    sections.recording.classList.remove('hidden');
                    break;
                case 5:
                    sections.completion.classList.remove('hidden');
                    AppState.experimentEndTimestamp = Date.now();
                    updateSummary();
                    break;
            }

            AppState.currentStep = step;
            updateProgress();
        }

        // æ›´æ–°è¿›åº¦æ¡
        function updateProgress() {
            const progressPercentage = (AppState.currentStep / 5) * 100;
            progressBar.style.width = `${progressPercentage}%`;
            
            // æ›´æ–°æ­¥éª¤çŠ¶æ€
            steps.forEach((step, index) => {
                if (index + 1 <= AppState.currentStep) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
            });
        }

        // åŠ è½½æ•…äº‹å›¾ç‰‡
        function loadStoryImages() {
            AppState.currentImageIndex = 0;
            document.getElementById('total-pages').textContent = AppState.totalImages;
            
            // åˆå§‹åŒ–å›¾ç‰‡æµè§ˆæ—¶é—´è®°å½•
            AppState.imageViewTimes = new Array(AppState.totalImages).fill(0);
            AppState.pageNavigationLog = [];
            
            showCurrentImage();
        }

        // æ˜¾ç¤ºå½“å‰å›¾ç‰‡
        function showCurrentImage() {
            // è®°å½•å‰ä¸€å¼ å›¾ç‰‡çš„æµè§ˆæ—¶é—´
            if (AppState.currentImageViewStart && AppState.currentImageIndex >= 0) {
                const viewTime = Date.now() - AppState.currentImageViewStart;
                if (AppState.imageViewTimes[AppState.currentImageIndex] !== undefined) {
                    AppState.imageViewTimes[AppState.currentImageIndex] += viewTime;
                }
            }
            
            const imageNumber = AppState.currentImageIndex + AppConfig.startIndex;
            const imageUrl = `${AppConfig.imageFolder}/${imageNumber}.${AppConfig.imageFormat}`;
            
            const imgElement = document.getElementById('current-image');
            
            // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯å¤„ç†
            imgElement.onerror = null;
            
            // è®¾ç½®æ–°çš„é”™è¯¯å¤„ç†
            imgElement.onerror = function() {
                console.error(`æ— æ³•åŠ è½½å›¾ç‰‡: ${imageUrl}`);
                // æ˜¾ç¤ºå ä½å›¾ç‰‡
                this.onerror = null; // é˜²æ­¢å¾ªç¯
                this.src = `https://placehold.co/800x500/4a6fa5/white?text=æ•…äº‹å›¾ç‰‡${imageNumber}&font=arial`;
                this.alt = `æ•…äº‹å›¾ç‰‡ ${imageNumber}ï¼ˆå ä½å›¾ï¼‰`;
            };
            
            imgElement.onload = function() {
                console.log(`æˆåŠŸåŠ è½½å›¾ç‰‡: ${imageUrl}`);
            };
            
            // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
            imgElement.src = imageUrl + `?t=${Date.now()}`;
            imgElement.alt = `æ•…äº‹å›¾ç‰‡ ${imageNumber}`;
            
            document.getElementById('current-page').textContent = AppState.currentImageIndex + 1;
            
            // å¼€å§‹è®°å½•å½“å‰å›¾ç‰‡çš„æµè§ˆæ—¶é—´
            AppState.currentImageViewStart = Date.now();
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            
            if (prevBtn && nextBtn) {
                prevBtn.disabled = AppState.currentImageIndex === 0;
                nextBtn.disabled = AppState.currentImageIndex === AppState.totalImages - 1;
            }
        }

        // æ˜¾ç¤ºä¸Šä¸€å¼ å›¾ç‰‡
        function showPrevImage() {
            if (AppState.currentImageIndex > 0) {
                AppState.currentImageIndex--;
                showCurrentImage();
            }
        }

        // æ˜¾ç¤ºä¸‹ä¸€å¼ å›¾ç‰‡
        function showNextImage() {
            if (AppState.currentImageIndex < AppState.totalImages - 1) {
                AppState.currentImageIndex++;
                showCurrentImage();
            }
        }

        // åŠ è½½æ‰€æœ‰å›¾ç‰‡ç”¨äºå½•éŸ³ç•Œé¢
        function loadAllImages() {
            const container = document.getElementById('all-images-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            for (let i = 0; i < AppState.totalImages; i++) {
                const img = document.createElement('img');
                const imageNumber = i + AppConfig.startIndex;
                const imageUrl = `${AppConfig.imageFolder}/${imageNumber}.${AppConfig.imageFormat}`;
                
                // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
                const cacheBuster = `?t=${Date.now() + i}`; // æ¯å¼ å›¾ç‰‡ä¸åŒçš„æ—¶é—´æˆ³
                
                img.src = imageUrl + cacheBuster;
                img.alt = `æ•…äº‹å›¾ç‰‡ ${i + 1}`;
                img.className = 'story-thumbnail';
                
                // æ·»åŠ é”™è¯¯å¤„ç†
                img.onerror = function() {
                    console.error(`æ— æ³•åŠ è½½ç¼©ç•¥å›¾: ${imageUrl}`);
                    this.onerror = null; // é˜²æ­¢å¾ªç¯
                    this.src = `https://placehold.co/180x120/6b9ac4/white?text=å›¾ç‰‡${i+1}&font=arial`;
                };
                
                container.appendChild(img);
            }
        }

        // åˆå§‹åŒ–å½•éŸ³
        async function initRecording() {
            loadAllImages();
            
            // æ›´æ–°å½•éŸ³çŠ¶æ€æ˜¾ç¤º
            const statusElement = document.getElementById('recording-status');
            const messageElement = document.getElementById('recording-message');
            
            try {
                // åˆå§‹åŒ–WAVç¼–ç å™¨
                AppState.wavEncoder = new WavAudioEncoder(AppConfig.audioSampleRate, 1, 16);
                
                // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
                AppState.audioContext = new (window.AudioContext || window.webkitAudioContext)({
                    sampleRate: AppConfig.audioSampleRate
                });
                
                // è¯·æ±‚éº¦å…‹é£æƒé™
                AppState.mediaStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        channelCount: 1,
                        sampleRate: AppConfig.audioSampleRate,
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    }
                });
                
                // åˆ›å»ºåª’ä½“æº
                const source = AppState.audioContext.createMediaStreamSource(AppState.mediaStream);
                
                // åˆ›å»ºè„šæœ¬å¤„ç†å™¨
                AppState.processor = AppState.audioContext.createScriptProcessor(4096, 1, 1);
                
                // å¤„ç†éŸ³é¢‘æ•°æ®
                AppState.processor.onaudioprocess = function(event) {
                    if (AppState.isRecording) {
                        const inputData = event.inputBuffer.getChannelData(0);
                        AppState.wavEncoder.addAudioData(inputData);
                    }
                };
                
                // è¿æ¥èŠ‚ç‚¹
                source.connect(AppState.processor);
                AppState.processor.connect(AppState.audioContext.destination);
                
                // å¼€å§‹å½•éŸ³
                AppState.isRecording = true;
                AppState.timers.recordingStart = Date.now();
                AppState.recordingStartTimestamp = Date.now();
                statusElement.classList.add('recording');
                messageElement.innerHTML = '<span class="pulse"></span>æ­£åœ¨å½•éŸ³...è¯·å¼€å§‹è®²æ•…äº‹';
                
                // å¼€å§‹è®¡æ—¶å™¨
                startRecordingTimer();
                
            } catch (error) {
                console.error('æ— æ³•è®¿é—®éº¦å…‹é£:', error);
                messageElement.textContent = 'æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®ã€‚';
                messageElement.style.color = 'red';
                statusElement.style.backgroundColor = '#ffe6e6';
                statusElement.style.borderColor = '#ffcccc';
                
                // å›é€€åˆ°ä½¿ç”¨MediaRecorder API
                console.log('å°è¯•ä½¿ç”¨MediaRecorder APIä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ...');
                setTimeout(() => initRecordingFallback(), 1000);
            }
        }

        // å¤‡é€‰å½•éŸ³æ–¹æ¡ˆï¼ˆä½¿ç”¨MediaRecorder APIï¼‰
        async function initRecordingFallback() {
            const statusElement = document.getElementById('recording-status');
            const messageElement = document.getElementById('recording-message');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const mediaRecorder = new MediaRecorder(stream);
                const audioChunks = [];
                
                mediaRecorder.addEventListener('dataavailable', event => {
                    audioChunks.push(event.data);
                });
                
                mediaRecorder.addEventListener('start', () => {
                    AppState.isRecording = true;
                    AppState.timers.recordingStart = Date.now();
                    AppState.recordingStartTimestamp = Date.now();
                    statusElement.classList.add('recording');
                    messageElement.innerHTML = '<span class="pulse"></span>æ­£åœ¨å½•éŸ³...è¯·å¼€å§‹è®²æ•…äº‹';
                    startRecordingTimer();
                });
                
                mediaRecorder.addEventListener('stop', () => {
                    AppState.isRecording = false;
                    AppState.timers.recordingTime = Date.now() - AppState.timers.recordingStart;
                    AppState.timers.totalTime = Date.now() - AppState.timers.totalStart;
                    
                    // åˆ›å»ºwebmæ ¼å¼çš„Blob
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    AppState.wavBlob = audioBlob;
                    
                    statusElement.classList.remove('recording');
                    messageElement.textContent = 'å½•éŸ³å·²å®Œæˆï¼';
                    
                    stream.getTracks().forEach(track => track.stop());
                    
                    goToStep(5);
                });
                
                mediaRecorder.start();
                
                // å­˜å‚¨å¼•ç”¨ä»¥ä¾¿åœæ­¢
                AppState.mediaRecorderFallback = mediaRecorder;
                AppState.audioChunksFallback = audioChunks;
                
            } catch (error) {
                console.error('å¤‡é€‰å½•éŸ³æ–¹æ¡ˆä¹Ÿå¤±è´¥äº†:', error);
                messageElement.textContent = 'å½•éŸ³åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚';
            }
        }

        // å¼€å§‹å½•éŸ³è®¡æ—¶å™¨
        function startRecordingTimer() {
            const timerElement = document.querySelector('#recording-status .timer');
            if (!timerElement) return;
            
            const startTime = Date.now();
            
            const timerInterval = setInterval(() => {
                if (!AppState.isRecording) {
                    clearInterval(timerInterval);
                    return;
                }
                
                const elapsedTime = Date.now() - startTime;
                const seconds = Math.floor(elapsedTime / 1000);
                const minutes = Math.floor(seconds / 60);
                const displaySeconds = seconds % 60;
                
                timerElement.textContent = `å½•éŸ³æ—¶é—´: ${minutes.toString().padStart(2, '0')}:${displaySeconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // åœæ­¢å½•éŸ³
        function stopRecording() {
            if (!AppState.isRecording) return;
            
            AppState.isRecording = false;
            AppState.timers.recordingTime = Date.now() - AppState.timers.recordingStart;
            AppState.timers.totalTime = Date.now() - AppState.timers.totalStart;
            
            // åœæ­¢æ‰€æœ‰éŸ³é¢‘å¤„ç†
            if (AppState.processor) {
                AppState.processor.disconnect();
            }
            
            if (AppState.mediaStream) {
                AppState.mediaStream.getTracks().forEach(track => track.stop());
            }
            
            if (AppState.audioContext && AppState.audioContext.state !== 'closed') {
                AppState.audioContext.close();
            }
            
            // åœæ­¢å¤‡é€‰æ–¹æ¡ˆçš„å½•éŸ³
            if (AppState.mediaRecorderFallback && AppState.mediaRecorderFallback.state === 'recording') {
                AppState.mediaRecorderFallback.stop();
                return;
            }
            
            // ç”ŸæˆWAVæ–‡ä»¶
            if (AppState.wavEncoder) {
                AppState.wavBlob = AppState.wavEncoder.getWavBlob();
            }
            
            // è¿›å…¥å®Œæˆç•Œé¢
            setTimeout(() => goToStep(5), 500);
        }

        // ç”Ÿæˆå®éªŒæ•°æ®TXTå†…å®¹
        function generateExperimentData() {
            const formatTime = (ms, includeMs = false) => {
                if (!ms || ms <= 0) return '0ç§’';
                const seconds = Math.floor(ms / 1000);
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                const milliseconds = ms % 1000;
                
                if (minutes > 0) {
                    if (includeMs) {
                        return `${minutes}åˆ†${remainingSeconds.toString().padStart(2, '0')}.${milliseconds.toString().padStart(3, '0')}ç§’`;
                    }
                    return `${minutes}åˆ†${remainingSeconds}ç§’`;
                } else {
                    if (includeMs) {
                        return `${remainingSeconds}.${milliseconds.toString().padStart(3, '0')}ç§’`;
                    }
                    return `${remainingSeconds}ç§’`;
                }
            };
            
            const formatTimestamp = (timestamp) => {
                if (!timestamp) return 'N/A';
                const date = new Date(timestamp);
                return date.toLocaleString('zh-CN');
            };
            
            let txtContent = `=== æ•…äº‹è®²è¿°å®éªŒæ•°æ®è®°å½• ===\n\n`;
            
            // 1. åŸºæœ¬ä¿¡æ¯
            txtContent += `ã€è¢«è¯•è€…åŸºæœ¬ä¿¡æ¯ã€‘\n`;
            txtContent += `å§“åï¼š${AppState.childInfo.name || 'æœªå¡«å†™'}\n`;
            txtContent += `å¹´é¾„ï¼š${AppState.childInfo.age || 'æœªå¡«å†™'}\n`;
            txtContent += `æ€§åˆ«ï¼š${AppState.childInfo.gender || 'æœªå¡«å†™'}\n`;
            txtContent += `å®éªŒæ—¶é—´ï¼š${formatTimestamp(AppState.childInfo.experimentDate ? new Date(AppState.childInfo.experimentDate).getTime() : null)}\n`;
            txtContent += `å®éªŒå¼€å§‹æ—¶é—´ï¼š${formatTimestamp(AppState.timers.totalStart)}\n`;
            txtContent += `å®éªŒç»“æŸæ—¶é—´ï¼š${formatTimestamp(AppState.experimentEndTimestamp)}\n\n`;
            
            // 2. æ—¶é—´ç»Ÿè®¡
            txtContent += `ã€æ—¶é—´ç»Ÿè®¡ã€‘\n`;
            txtContent += `æ•…äº‹æµè§ˆæ€»ç”¨æ—¶ï¼š${formatTime(AppState.timers.browsingTime)}\n`;
            txtContent += `å½•éŸ³ç”¨æ—¶ï¼š${formatTime(AppState.timers.recordingTime)}\n`;
            txtContent += `å®éªŒæ€»ç”¨æ—¶ï¼š${formatTime(AppState.timers.totalTime)}\n\n`;
            
            // 3. å›¾ç‰‡æµè§ˆè¯¦æƒ…
            txtContent += `ã€å›¾ç‰‡æµè§ˆè¯¦æƒ…ã€‘\n`;
            txtContent += `æ€»å›¾ç‰‡æ•°ï¼š${AppState.totalImages}\n`;
            txtContent += `å›¾ç‰‡è·¯å¾„ï¼š${AppConfig.imageFolder}\n`;
            txtContent += `å›¾ç‰‡æ ¼å¼ï¼š${AppConfig.imageFormat}\n\n`;
            
            let totalImageViewTime = 0;
            for (let i = 0; i < AppState.totalImages; i++) {
                const viewTime = AppState.imageViewTimes[i] || 0;
                totalImageViewTime += viewTime;
                txtContent += `å›¾ç‰‡ ${i + 1}ï¼šæµè§ˆæ—¶é—´ ${formatTime(viewTime, true)}\n`;
            }
            
            txtContent += `\nå›¾ç‰‡æµè§ˆæ€»æ—¶é—´ï¼š${formatTime(totalImageViewTime)}\n`;
            if (AppState.totalImages > 0) {
                txtContent += `å¹³å‡æ¯å¼ å›¾ç‰‡æµè§ˆæ—¶é—´ï¼š${formatTime(totalImageViewTime / AppState.totalImages)}\n`;
            }
            txtContent += `\n`;
            
            // 4. å½•éŸ³ä¿¡æ¯
            txtContent += `ã€å½•éŸ³ä¿¡æ¯ã€‘\n`;
            if (AppState.wavBlob) {
                const fileSize = (AppState.wavBlob.size / 1024).toFixed(2);
                const isWav = AppState.wavBlob.type === 'audio/wav';
                txtContent += `éŸ³é¢‘æ ¼å¼ï¼š${isWav ? 'WAV' : 'WEBM'}\n`;
                txtContent += `æ–‡ä»¶å¤§å°ï¼š${fileSize} KB\n`;
                txtContent += `å½•éŸ³å¼€å§‹æ—¶é—´ï¼š${formatTimestamp(AppState.recordingStartTimestamp)}\n`;
            } else {
                txtContent += `éŸ³é¢‘æ–‡ä»¶ï¼šæœªç”Ÿæˆ\n`;
            }
            txtContent += `\n`;
            
            // 5. é¡µé¢å¯¼èˆªè®°å½•
            txtContent += `ã€é¡µé¢å¯¼èˆªè®°å½•ã€‘\n`;
            if (AppState.pageNavigationLog.length > 0) {
                for (const log of AppState.pageNavigationLog) {
                    const stepNames = ['åŸºæœ¬ä¿¡æ¯', 'æŒ‡å¯¼è¯­', 'æµè§ˆæ•…äº‹', 'å½•éŸ³', 'å®Œæˆ'];
                    txtContent += `ä»"${stepNames[log.fromStep - 1]}"åˆ°"${stepNames[log.toStep - 1]}" - å®éªŒå¼€å§‹å ${formatTime(log.timeFromStart, true)}\n`;
                }
            } else {
                txtContent += `æ— å¯¼èˆªè®°å½•\n`;
            }
            txtContent += `\n`;
            
            // 6. ç³»ç»Ÿä¿¡æ¯
            txtContent += `ã€ç³»ç»Ÿä¿¡æ¯ã€‘\n`;
            txtContent += `ç”¨æˆ·ä»£ç†ï¼š${navigator.userAgent}\n`;
            txtContent += `å±å¹•åˆ†è¾¨ç‡ï¼š${window.screen.width}x${window.screen.height}\n`;
            txtContent += `æµè§ˆå™¨è¯­è¨€ï¼š${navigator.language}\n`;
            txtContent += `åœ¨çº¿çŠ¶æ€ï¼š${navigator.onLine ? 'åœ¨çº¿' : 'ç¦»çº¿'}\n`;
            txtContent += `å›¾ç‰‡æ–‡ä»¶å¤¹ï¼š${AppConfig.imageFolder}\n`;
            txtContent += `å›¾ç‰‡æ ¼å¼ï¼š${AppConfig.imageFormat}\n`;
            txtContent += `éŸ³é¢‘é‡‡æ ·ç‡ï¼š${AppConfig.audioSampleRate} Hz\n`;
            txtContent += `\n`;
            
            // 7. å®éªŒå¤‡æ³¨
            txtContent += `ã€å®éªŒå¤‡æ³¨ã€‘\n`;
            txtContent += `æ•°æ®ç”Ÿæˆæ—¶é—´ï¼š${formatTimestamp(Date.now())}\n`;
            
            return txtContent;
        }

        // ç”ŸæˆREADMEæ–‡ä»¶å†…å®¹
        function generateReadmeContent() {
            const formatTimestamp = (timestamp) => {
                if (!timestamp) return 'N/A';
                const date = new Date(timestamp);
                return date.toLocaleString('zh-CN');
            };
            
            let content = `=== æ•…äº‹è®²è¿°å®éªŒæ–‡ä»¶è¯´æ˜ ===\n\n`;
            content += `æ­¤å‹ç¼©åŒ…åŒ…å«ä»¥ä¸‹æ–‡ä»¶ï¼š\n\n`;
            content += `1. éŸ³é¢‘æ–‡ä»¶ (.wav æˆ– .webm)\n`;
            content += `   - è¢«è¯•è€…è®²æ•…äº‹çš„å®Œæ•´å½•éŸ³\n`;
            content += `   - å¯ä»¥ä½¿ç”¨ä»»ä½•éŸ³é¢‘æ’­æ”¾å™¨æ‰“å¼€\n\n`;
            content += `2. å®éªŒæ•°æ®æ–‡ä»¶ (.txt)\n`;
            content += `   - åŒ…å«å®Œæ•´çš„å®éªŒè¿‡ç¨‹æ•°æ®\n`;
            content += `   - åŒ…æ‹¬è¢«è¯•ä¿¡æ¯ã€æ—¶é—´ç»Ÿè®¡ã€å›¾ç‰‡æµè§ˆè¯¦æƒ…ç­‰\n\n`;
            content += `3. æœ¬è¯´æ˜æ–‡ä»¶\n\n`;
            content += `å®éªŒä¿¡æ¯ï¼š\n`;
            content += `- è¢«è¯•è€…ï¼š${AppState.childInfo.name || 'æœªå¡«å†™'}\n`;
            content += `- å®éªŒæ—¶é—´ï¼š${formatTimestamp(AppState.timers.totalStart)}\n`;
            content += `- æ•°æ®ç”Ÿæˆæ—¶é—´ï¼š${formatTimestamp(Date.now())}\n\n`;
            content += `å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·è”ç³»å®éªŒç®¡ç†å‘˜ã€‚\n`;
            
            return content;
        }

        // æ›´æ–°æ•°æ®æ‘˜è¦
        function updateSummary() {
            // æ ¼å¼åŒ–æ—¶é—´
            const formatTime = (ms) => {
                if (!ms || ms <= 0) return '0ç§’';
                const seconds = Math.floor(ms / 1000);
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                
                if (minutes > 0) {
                    return `${minutes}åˆ†${remainingSeconds}ç§’`;
                } else {
                    return `${remainingSeconds}ç§’`;
                }
            };
            
            // æ›´æ–°æ‘˜è¦ä¿¡æ¯
            document.getElementById('summary-name').textContent = AppState.childInfo.name || 'æœªå¡«å†™';
            document.getElementById('summary-age').textContent = AppState.childInfo.age || 'æœªå¡«å†™';
            document.getElementById('summary-gender').textContent = AppState.childInfo.gender || 'æœªå¡«å†™';
            document.getElementById('summary-date').textContent = AppState.childInfo.experimentDate ? 
                new Date(AppState.childInfo.experimentDate).toLocaleString('zh-CN') : 'æœªå¡«å†™';
            document.getElementById('summary-browsing-time').textContent = formatTime(AppState.timers.browsingTime);
            document.getElementById('summary-recording-time').textContent = formatTime(AppState.timers.recordingTime);
            document.getElementById('summary-total-time').textContent = formatTime(AppState.timers.totalTime);
            
            // æ˜¾ç¤ºéŸ³é¢‘æ–‡ä»¶ä¿¡æ¯
            if (AppState.wavBlob) {
                const fileSize = (AppState.wavBlob.size / 1024).toFixed(2);
                const isWav = AppState.wavBlob.type === 'audio/wav';
                document.getElementById('summary-audio-file').textContent = 
                    `${isWav ? 'WAV' : 'WEBM'}æ ¼å¼, ${fileSize}KB`;
                
                // è®¾ç½®éŸ³é¢‘é¢„è§ˆ
                const audioUrl = URL.createObjectURL(AppState.wavBlob);
                const audioPlayer = document.getElementById('audio-player');
                audioPlayer.src = audioUrl;
                
                // æ¸…ç†URL
                setTimeout(() => URL.revokeObjectURL(audioUrl), 1000);
            }
            
            // æ˜¾ç¤ºæ•°æ®æ–‡ä»¶ä¿¡æ¯
            const dataContent = generateExperimentData();
            const dataSize = new Blob([dataContent]).size;
            const audioSize = AppState.wavBlob ? AppState.wavBlob.size : 0;
            const readmeSize = new Blob([generateReadmeContent()]).size;
            const estimatedZipSize = dataSize + audioSize + readmeSize;
            document.getElementById('summary-data-file').textContent = `ZIPåŒ…, çº¦${(estimatedZipSize / 1024).toFixed(2)}KB`;
        }

        // ä¸‹è½½æ‰€æœ‰æ–‡ä»¶ï¼ˆæ‰“åŒ…ä¸ºZIPï¼‰
        async function downloadAllFiles() {
            if (!AppState.wavBlob) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„å½•éŸ³æ–‡ä»¶');
                return;
            }
            
            if (AppState.isGeneratingZip) {
                return;
            }
            
            try {
                AppState.isGeneratingZip = true;
                const downloadBtn = document.getElementById('download-all');
                const originalText = downloadBtn.textContent;
                downloadBtn.textContent = 'æ­£åœ¨ç”ŸæˆZIPæ–‡ä»¶...';
                downloadBtn.disabled = true;
                
                // åˆ›å»ºZIPæ–‡ä»¶
                const zip = new JSZip();
                
                // ç”Ÿæˆæ–‡ä»¶åå‰ç¼€
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:]/g, '-');
                const namePrefix = AppState.childInfo.name ? `${AppState.childInfo.name}_` : '';
                
                // 1. æ·»åŠ éŸ³é¢‘æ–‡ä»¶
                const isWav = AppState.wavBlob.type === 'audio/wav';
                const audioExtension = isWav ? 'wav' : 'webm';
                const audioFilename = `${namePrefix}è®²æ•…äº‹å½•éŸ³_${timestamp}.${audioExtension}`;
                zip.file(audioFilename, AppState.wavBlob);
                
                // 2. æ·»åŠ å®éªŒæ•°æ®æ–‡ä»¶
                const dataContent = generateExperimentData();
                const dataFilename = `${namePrefix}å®éªŒæ•°æ®_${timestamp}.txt`;
                zip.file(dataFilename, dataContent);
                
                // 3. æ·»åŠ è¯´æ˜æ–‡ä»¶
                const readmeContent = generateReadmeContent();
                const readmeFilename = `${namePrefix}æ–‡ä»¶è¯´æ˜_${timestamp}.txt`;
                zip.file(readmeFilename, readmeContent);
                
                // ç”ŸæˆZIPæ–‡ä»¶
                const zipBlob = await zip.generateAsync({ 
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: {
                        level: 6
                    }
                });
                
                // ä¸‹è½½ZIPæ–‡ä»¶
                const zipUrl = URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = zipUrl;
                a.download = `${namePrefix}æ•…äº‹å®éªŒæ•°æ®åŒ…_${timestamp}.zip`;
                
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                // é‡Šæ”¾URLå¯¹è±¡
                setTimeout(() => {
                    URL.revokeObjectURL(zipUrl);
                }, 100);
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                downloadBtn.textContent = originalText;
                downloadBtn.disabled = false;
                AppState.isGeneratingZip = false;
                
            } catch (error) {
                console.error('åˆ›å»ºZIPæ–‡ä»¶å¤±è´¥:', error);
                alert('åˆ›å»ºå‹ç¼©æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                const downloadBtn = document.getElementById('download-all');
                downloadBtn.textContent = 'ä¸‹è½½å®éªŒæ•°æ®åŒ…(ZIP)';
                downloadBtn.disabled = false;
                AppState.isGeneratingZip = false;
            }
        }

        // é‡æ–°å¼€å§‹å®éªŒ
        function restartExperiment() {
            // åœæ­¢æ‰€æœ‰éŸ³é¢‘å¤„ç†
            if (AppState.isRecording) {
                stopRecording();
            }
            
            // é‡ç½®åº”ç”¨çŠ¶æ€
            AppState.currentStep = 1;
            AppState.childInfo = {
                name: '',
                age: '',
                gender: '',
                experimentDate: ''
            };
            AppState.timers = {
                browsingStart: null,
                browsingTime: 0,
                recordingStart: null,
                recordingTime: 0,
                totalStart: null,
                totalTime: 0
            };
            AppState.currentImageIndex = 0;
            AppState.totalImages = 5;
            AppState.wavBlob = null;
            AppState.isRecording = false;
            AppState.imageViewTimes = [];
            AppState.currentImageViewStart = null;
            AppState.pageNavigationLog = [];
            AppState.recordingStartTimestamp = null;
            AppState.experimentEndTimestamp = null;
            AppState.isGeneratingZip = false;
            
            // æ¸…ç†éŸ³é¢‘èµ„æº
            if (AppState.audioContext && AppState.audioContext.state !== 'closed') {
                AppState.audioContext.close();
            }
            
            if (AppState.mediaStream) {
                AppState.mediaStream.getTracks().forEach(track => track.stop());
            }
            
            AppState.audioContext = null;
            AppState.mediaStream = null;
            AppState.processor = null;
            AppState.wavEncoder = null;
            AppState.mediaRecorderFallback = null;
            AppState.audioChunksFallback = null;
            
            // é‡ç½®è¡¨å•
            document.getElementById('child-info-form').reset();
            
            // è®¾ç½®å½“å‰æ—¥æœŸæ—¶é—´ä¸ºé»˜è®¤å€¼
            const now = new Date();
            const localDateTime = now.toISOString().slice(0, 16);
            document.getElementById('experiment-date').value = localDateTime;
            
            // é‡ç½®å›¾ç‰‡æ•°é‡
            const imageCountInput = document.getElementById('image-count');
            if (imageCountInput) {
                imageCountInput.value = 5;
            }
            
            // è¿”å›ç¬¬ä¸€æ­¥
            goToStep(1);
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>